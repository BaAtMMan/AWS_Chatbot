AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Chatbot Serverless Application with Amazon Lex V2 and Bedrock Knowledge
  Base Integration

  SAM Template for a chatbot using DynamoDB for session storage, Lambda functions
  for  fulfillment and API proxy, API Gateway for HTTP interface, and Amazon Bedrock
  Knowledge  Base for intelligent fallback responses.

  '
Globals:
  Function:
    Timeout: 30
    MemorySize: 256
    Runtime: python3.13
    Environment:
      Variables:
        LOG_LEVEL: INFO
Resources:
  SessionTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: SessionTable
      AttributeDefinitions:
      - AttributeName: session_id
        AttributeType: S
      KeySchema:
      - AttributeName: session_id
        KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
      - Key: Application
        Value: Chatbot
      - Key: Component
        Value: SessionStorage
  ChatbotFulfillmentLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ChatbotFulfillmentLambda
      CodeUri: ChatbotFulfillmentLambda
      Handler: app.lambda_handler
      Description: Lambda function for Lex V2 fulfillment with Bedrock Knowledge Base
        integration
      Environment:
        Variables:
          TABLE_NAME:
            Ref: SessionTable
          KB_ID: L5K2TDFDK3
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: SessionTable
      - Statement:
        - Sid: BedrockKnowledgeBaseAccess
          Effect: Allow
          Action:
          - bedrock:RetrieveAndGenerate
          - bedrock:Retrieve
          Resource:
          - arn:aws:bedrock:us-east-1:260003929445:knowledge-base/L5K2TDFDK3
      - Statement:
        - Sid: BedrockModelAccess
          Effect: Allow
          Action:
          - bedrock:InvokeModel
          Resource:
          - Fn::Sub: arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.*
      - Statement:
        - Sid: MarketplaceSubscriptionAccess
          Effect: Allow
          Action:
          - aws-marketplace:ViewSubscriptions
          - aws-marketplace:Subscribe
          Resource: '*'
      Tags:
        Application: Chatbot
        Component: Fulfillment
    Metadata:
      SamResourceId: ChatbotFulfillmentLambda
  LexInvokeFulfillmentPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: ChatbotFulfillmentLambda
      Action: lambda:InvokeFunction
      Principal: lexv2.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:lex:${AWS::Region}:${AWS::AccountId}:bot-alias/ZUD17UCEC4/*
  ApiProxyLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ApiProxyLambda
      CodeUri: ApiProxyLambda
      Handler: app.lambda_handler
      Description: Lambda function for API Gateway proxy to Amazon Lex V2
      Policies:
      - Statement:
        - Sid: LexRecognizeTextAccess
          Effect: Allow
          Action:
          - lex:RecognizeText
          Resource:
          - arn:aws:lex:us-east-1:260003929445:bot-alias/ZUD17UCEC4/UUORFDMIMY
      Events:
        ChatApiEvent:
          Type: HttpApi
          Properties:
            Path: /chat
            Method: post
            ApiId:
              Ref: ChatbotHttpApi
      Tags:
        Application: Chatbot
        Component: ApiProxy
    Metadata:
      SamResourceId: ApiProxyLambda
  ChatbotHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: prod
      Description: HTTP API for Chatbot with Lex and Bedrock integration
      CorsConfiguration:
        AllowCredentials: false
        AllowHeaders:
        - Content-Type
        - X-Amz-Date
        - Authorization
        - X-Api-Key
        - X-Requested-With
        AllowMethods:
        - GET
        - POST
        - OPTIONS
        AllowOrigins:
        - '*'
        MaxAge: 600
      Tags:
        Application: Chatbot
        Component: ApiGateway
Outputs:
  ChatApiUrl:
    Description: API Gateway endpoint URL for the /chat endpoint
    Value:
      Fn::Sub: https://${ChatbotHttpApi}.execute-api.${AWS::Region}.amazonaws.com/prod/chat
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ChatApiUrl
  SessionTableName:
    Description: Name of the DynamoDB Session Table
    Value:
      Ref: SessionTable
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-SessionTableName
  SessionTableArn:
    Description: ARN of the DynamoDB Session Table
    Value:
      Fn::GetAtt:
      - SessionTable
      - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-SessionTableArn
  ChatbotFulfillmentLambdaArn:
    Description: ARN of the Chatbot Fulfillment Lambda Function
    Value:
      Fn::GetAtt:
      - ChatbotFulfillmentLambda
      - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ChatbotFulfillmentLambdaArn
  ChatbotFulfillmentLambdaName:
    Description: Name of the Chatbot Fulfillment Lambda Function
    Value:
      Ref: ChatbotFulfillmentLambda
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ChatbotFulfillmentLambdaName
  ApiProxyLambdaArn:
    Description: ARN of the API Proxy Lambda Function
    Value:
      Fn::GetAtt:
      - ApiProxyLambda
      - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ApiProxyLambdaArn
  ApiProxyLambdaName:
    Description: Name of the API Proxy Lambda Function
    Value:
      Ref: ApiProxyLambda
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ApiProxyLambdaName
  BedrockKnowledgeBaseId:
    Description: Bedrock Knowledge Base ID used by the chatbot
    Value: L5K2TDFDK3
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-BedrockKnowledgeBaseId
  LexBotAliasArn:
    Description: Amazon Lex Bot Alias ARN
    Value: arn:aws:lex:us-east-1:260003929445:bot-alias/ZUD17UCEC4/UUORFDMIMY
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-LexBotAliasArn
